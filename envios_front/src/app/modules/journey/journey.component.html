<div *ngIf="showLoading" class="fixed inset-0 z-50 flex items-center justify-center bg-white/30 dark:bg-[#1063ac]/30 backdrop-blur-sm">
<div class="p-8 bg-white dark:bg-gray-800 rounded-lg shadow-xl">
   <div role="status">
   <span class="sr-only">Loading...</span>
</div>
<p class="mt-4 text-center text-gray-600 dark:text-gray-300">Procesando...</p>
</div>
</div>


<form *ngIf="journeyForm" [formGroup]="journeyForm" class="bg-white p-6 rounded-2xl shadow-md w-full max-w-4xl mx-auto">
  <!-- SECCI√ìN TRANSPORTISTA -->
  <h3 class="text-lg font-semibold text-gray-800 mb-4">üöõ Transportista</h3>

  <div formGroupName="transportista" class="grid md:grid-cols-2 gap-4 mb-6">
    <div class="flex flex-col">
      <input formControlName="nombre" placeholder="Nombre" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <div *ngIf="journeyForm.get('transportista.nombre')?.invalid && journeyForm.get('transportista.nombre')?.touched" class="text-red-500 text-xs mt-1">
        <span *ngIf="journeyForm.get('transportista.nombre')?.errors?.['required']">Nombre es requerido</span>
        <span *ngIf="journeyForm.get('transportista.nombre')?.errors?.['minlength']">M√≠nimo 3 caracteres</span>
      </div>
    </div>

    <div class="flex flex-col">
      <input formControlName="identificacion" placeholder="Identificaci√≥n" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <div *ngIf="journeyForm.get('transportista.identificacion')?.invalid && journeyForm.get('transportista.identificacion')?.touched" class="text-red-500 text-xs mt-1">
        <span *ngIf="journeyForm.get('transportista.identificacion')?.errors?.['required']">Identificaci√≥n es requerida</span>
        <span *ngIf="journeyForm.get('transportista.identificacion')?.errors?.['pattern']">Formato inv√°lido (10-13 d√≠gitos)</span>
      </div>
    </div>

    <div class="flex flex-col">
      <input formControlName="telefono" placeholder="Tel√©fono" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <div *ngIf="journeyForm.get('transportista.telefono')?.invalid && journeyForm.get('transportista.telefono')?.touched" class="text-red-500 text-xs mt-1">
        <span *ngIf="journeyForm.get('transportista.telefono')?.errors?.['required']">Tel√©fono es requerido</span>
        <span *ngIf="journeyForm.get('transportista.telefono')?.errors?.['pattern']">Formato inv√°lido (10 d√≠gitos)</span>
      </div>
    </div>

    <div class="flex flex-col">
      <input formControlName="email" placeholder="Email" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <div *ngIf="journeyForm.get('transportista.email')?.invalid && journeyForm.get('transportista.email')?.touched" class="text-red-500 text-xs mt-1">
        <span *ngIf="journeyForm.get('transportista.email')?.errors?.['required']">Email es requerido</span>
        <span *ngIf="journeyForm.get('transportista.email')?.errors?.['email']">Email inv√°lido</span>
      </div>
    </div>

    <div class="flex flex-col">
      <input formControlName="empresa" placeholder="Empresa" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <span *ngIf="journeyForm.get('transportista.empresa')?.invalid && journeyForm.get('transportista.empresa')?.touched" class="text-red-500 text-xs mt-1">
        Empresa es requerida
      </span>
    </div>

    <div class="flex flex-col">
      <input formControlName="licencia_transporte" placeholder="Licencia de Transporte" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <div *ngIf="journeyForm.get('transportista.licencia_transporte')?.invalid && journeyForm.get('transportista.licencia_transporte')?.touched" class="text-red-500 text-xs mt-1">
        <span *ngIf="journeyForm.get('transportista.licencia_transporte')?.errors?.['required']">Licencia es requerida</span>
        <span *ngIf="journeyForm.get('transportista.licencia_transporte')?.errors?.['minlength']">M√≠nimo 5 caracteres</span>
      </div>
    </div>
  </div>


  <h3 class="text-lg font-semibold text-gray-800 mb-4">üöê Veh√≠culo</h3>
  <div formGroupName="vehiculo" class="grid md:grid-cols-2 gap-4 mb-6">
    <div class="flex flex-col">
      <input formControlName="placa" placeholder="Placa" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <div *ngIf="journeyForm.get('vehiculo.placa')?.invalid && journeyForm.get('vehiculo.placa')?.touched" class="text-red-500 text-xs mt-1">
        <span *ngIf="journeyForm.get('vehiculo.placa')?.errors?.['required']">Placa es requerida</span>
        <span *ngIf="journeyForm.get('vehiculo.placa')?.errors?.['pattern']">Formato inv√°lido (ej: ABC-123)</span>
      </div>
    </div>

    <div class="flex flex-col">
      <input formControlName="marca" placeholder="Marca" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <span *ngIf="journeyForm.get('vehiculo.marca')?.invalid && journeyForm.get('vehiculo.marca')?.touched" class="text-red-500 text-xs mt-1">
        Marca es requerida
      </span>
    </div>

    <div class="flex flex-col">
      <input formControlName="modelo" placeholder="Modelo" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <span *ngIf="journeyForm.get('vehiculo.modelo')?.invalid && journeyForm.get('vehiculo.modelo')?.touched" class="text-red-500 text-xs mt-1">
        Modelo es requerido
      </span>
    </div>

    <div class="flex flex-col">
      <input formControlName="capacidad" type="number" placeholder="Capacidad (kg)" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <div *ngIf="journeyForm.get('vehiculo.capacidad')?.invalid && journeyForm.get('vehiculo.capacidad')?.touched" class="text-red-500 text-xs mt-1">
        <span *ngIf="journeyForm.get('vehiculo.capacidad')?.errors?.['required']">Capacidad es requerida</span>
        <span *ngIf="journeyForm.get('vehiculo.capacidad')?.errors?.['min']">M√≠nimo 100 kg</span>
        <span *ngIf="journeyForm.get('vehiculo.capacidad')?.errors?.['max']">M√°ximo 50,000 kg</span>
      </div>
    </div>
  </div>

  <!-- SECCI√ìN VIAJE -->
  <h3 class="text-lg font-semibold text-gray-800 mb-4">üó∫Ô∏è Viaje</h3>
  <div formGroupName="envio" class="grid md:grid-cols-2 gap-4 mb-6">
    <div class="flex flex-col">
      <label class="text-sm text-gray-600 mb-1">Fecha estimada de fin <span class="text-red-500">*</span></label>
      <input formControlName="fecha_fin_estimada" type="datetime-local" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500" />
      <span *ngIf="journeyForm.get('envio.fecha_fin_estimada')?.invalid && journeyForm.get('envio.fecha_fin_estimada')?.touched" 
            class="text-red-500 text-xs mt-1">
        Fecha estimada es requerida
      </span>
    </div>
    
    <div class="flex flex-col relative">
      <label class="text-sm text-gray-600 mb-1">Ciudad origen <span class="text-red-500">*</span></label>
      <input 
        [formControl]="originSearchControl"
        (focus)="handleOriginFocus()"
        (blur)="handleOriginBlur()"
        placeholder="Buscar ciudad..."
        class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 pr-8"
      />
      <span *ngIf="journeyForm.get('envio.origen')?.invalid && journeyForm.get('envio.origen')?.touched" 
            class="text-red-500 text-xs mt-1">
        Ciudad origen es requerida
      </span>
      
      <span 
        class="absolute right-3 top-9 transform -translate-y-1/2 cursor-pointer"
        (click)="toggleOriginDropdown()"
      >
        ‚ñº
      </span>
    
      <div 
        class="absolute z-50 w-full mt-1 bg-white rounded-lg shadow-lg max-h-60 overflow-y-auto border top-full"
        *ngIf="showOriginDropdown"
      >
        <div 
          *ngFor="let city of filteredOriginCities"
          class="p-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center"
          (click)="selectOriginCity(city)"
          [class.bg-blue-50]="journeyForm.get('envio.origen')?.value === city.value"
        >
          <span>{{ city.text }}</span>
          <span *ngIf="journeyForm.get('envio.origen')?.value === city.value" class="text-blue-500">‚úì</span>
        </div>
    
        <div *ngIf="filteredOriginCities.length === 0" class="p-2 text-sm text-gray-500">
          No se encontraron ciudades
        </div>
      </div>
    </div>
    
    <div class="flex flex-col relative">
      <label class="text-sm text-gray-600 mb-1">Ciudad destino <span class="text-red-500">*</span></label>
      <input 
        [formControl]="destinationSearchControl"
        (focus)="handleDestinationFocus()"
        (blur)="handleDestinationBlur()"
        class="p-2 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 pr-8"
        placeholder="Buscar ciudad..."
      />
      <span *ngIf="journeyForm.get('envio.destino')?.invalid && journeyForm.get('envio.destino')?.touched" 
            class="text-red-500 text-xs mt-1">
        Ciudad destino es requerida
      </span>
      <span 
        class="absolute right-3 top-9 transform -translate-y-1/2 cursor-pointer"
        (click)="toggleDestinationDropdown()"
      >
        ‚ñº
      </span>
      
      <div 
        class="absolute z-50 w-full mt-1 bg-white rounded-lg shadow-lg max-h-60 overflow-y-auto border top-full"
        *ngIf="showDestinationDropdown"
      >
        <div 
          *ngFor="let city of filteredDestinationCities"
          class="p-2 hover:bg-gray-100 cursor-pointer flex justify-between items-center"
          (click)="selectDestinationCity(city)"
          [class.bg-blue-50]="journeyForm.get('envio.destino')?.value === city.value"
        >
          <span>{{city.text}}</span>
          <span *ngIf="journeyForm.get('envio.destino')?.value === city.value" class="text-blue-500">‚úì</span>
        </div>
        
        <div *ngIf="filteredDestinationCities.length === 0" class="p-2 text-sm text-gray-500">
          No se encontraron ciudades
        </div>
      </div>
    </div>
  </div>

  <!-- BOT√ìN DE ENV√çO -->
  <div *ngIf="journeyForm.invalid && (journeyForm.touched || journeyForm.dirty)" class="mb-4">
    <span class="text-red-500 text-sm">
      ‚ö†Ô∏è Por favor, complete correctamente todos los campos requeridos
    </span>
  </div>

  <button 
    type="submit" 
    (click)="onSubmit()" 
    class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-all w-full md:w-auto disabled:opacity-50 disabled:cursor-not-allowed"
    [disabled]="journeyForm.invalid"
  >
    Crear Todo
  </button>
</form>
